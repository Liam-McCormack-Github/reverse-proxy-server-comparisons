services:
  target-server:
    build:
      context: ./target-server
      args:
        - TARGET_SERVER_PORT=${TARGET_SERVER_PORT}
    ports:
      - "${TARGET_SERVER_PORT}:${TARGET_SERVER_PORT}"
    environment:
      - TARGET_SERVER_PORT=${TARGET_SERVER_PORT}
      - TARGET_SERVER_HOST=${TARGET_SERVER_HOST}

  go-proxy:
    build:
      context: ./go-proxy
      args:
        - GO_PROXY_SERVER_PORT=${GO_PROXY_SERVER_PORT}
    ports:
      - "${GO_PROXY_SERVER_PORT}:${GO_PROXY_SERVER_PORT}"
    environment:
      - GO_PROXY_SERVER_PORT=${GO_PROXY_SERVER_PORT}
      - TARGET_SERVER_HOST=target-server
      - TARGET_SERVER_PORT=${TARGET_SERVER_PORT}
      - GO_PROXY_ADMIN_ID=${GO_PROXY_ADMIN_ID}
      - GO_PROXY_ADMIN_SECRET=${GO_PROXY_ADMIN_SECRET}
      - GO_PROXY_REAUTH_COOLDOWN_MS=${GO_PROXY_REAUTH_COOLDOWN_MS}
      - GO_PROXY_RETRY_ATTEMPTS=${GO_PROXY_RETRY_ATTEMPTS}
      - GO_PROXY_RETRY_INTERVAL_MS=${GO_PROXY_RETRY_INTERVAL_MS}
    depends_on:
      - target-server

  manual-test:
    build:
      context: ./tests/manual
    entrypoint: /bin/sh
    command: -c "sleep infinity"
    stdin_open: true
    tty: true
